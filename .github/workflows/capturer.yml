name: Capturer build

on:
  push:
    branches: [main]
    paths:
      - 'capturer/**'
      - '.github/workflows/capturer.yml'
  pull_request:
    branches: [main]
    paths:
      - 'capturer/**'
      - '.github/workflows/capturer.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-binaries:
    name: Build capturer (multi-arch, libc)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - { name: amd64, platform: linux/amd64, TARGETARCH: amd64, TARGETVARIANT: "" }
          - { name: x86, platform: linux/386, TARGETARCH: 386, TARGETVARIANT: "" }
          - { name: armv6, platform: linux/arm/v6, TARGETARCH: arm, TARGETVARIANT: 6 }
          - { name: armv7, platform: linux/arm/v7, TARGETARCH: arm, TARGETVARIANT: 7 }
          - { name: arm64, platform: linux/arm64, TARGETARCH: arm64, TARGETVARIANT: "" }
        libc: [musl, glibc]
        exclude:
          # No glibc build for armv6: official golang Debian images are not published for linux/arm/v6.
          - target: { name: armv6, platform: linux/arm/v6, TARGETARCH: arm, TARGETVARIANT: 6 }
            libc: glibc
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up buildx
        uses: docker/setup-buildx-action@v3

      - name: Choose base image for libc
        run: |
          # Pick a base image that actually exists for the requested platform.
          # Note: official `golang:*-(bullseye|bookworm)` tags are not published for all variants (notably arm/v6 and 386).
          platform="${{ matrix.target.platform }}"
          libc="${{ matrix.libc }}"

          if [ "$libc" = "musl" ]; then
            # Alpine/musl (official golang tag includes amd64/386/armv6/armv7/arm64)
            base="golang:1.24-alpine3.23"
          else
            # Debian/glibc (official tag includes amd64/386/armv7/arm64)
            base="golang:1.24-bullseye"
          fi

          echo "BASE_IMAGE=$base" >> $GITHUB_ENV
          echo "Using BASE_IMAGE=$base for $platform ($libc)"

      - name: Build image for target
        uses: docker/build-push-action@v5
        with:
          context: capturer
          file: capturer/Dockerfile
          platforms: ${{ matrix.target.platform }}
          push: false
          load: true
          tags: |
            capturer:${{ matrix.target.name }}-${{ matrix.libc }}
          build-args: |
            BASE_IMAGE=${{ env.BASE_IMAGE }}
            TARGETOS=linux
            TARGETARCH=${{ matrix.target.TARGETARCH }}
            TARGETVARIANT=${{ matrix.target.TARGETVARIANT }}

      - name: Extract binary from image
        run: |
          mkdir -p artifacts
          IMAGE_NAME=capturer:${{ matrix.target.name }}-${{ matrix.libc }}
          CONTAINER_ID=$(docker create $IMAGE_NAME)
          docker cp $CONTAINER_ID:/app/main ./artifacts/capturer-${{ matrix.target.name }}-${{ matrix.libc }}
          docker rm $CONTAINER_ID

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: capturer-${{ matrix.target.name }}-${{ matrix.libc }}
          path: ./artifacts/capturer-${{ matrix.target.name }}-${{ matrix.libc }}
          retention-days: 30

  release:
    name: Publish latest release
    runs-on: ubuntu-latest
    needs: [build-binaries]
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: capturer-*
          merge-multiple: true
          path: ./dist

      - name: Generate sha256 files
        run: |
          ls -lah ./dist
          cd ./dist
          for f in *; do
            if [ -f "$f" ] && [ "$f" != "*.sha256" ]; then
              sha256sum "$f" > "$f.sha256"
            fi
          done
          ls -lah

      - name: Create or update latest release
        uses: ncipollo/release-action@v1
        with:
          tag: latest
          name: Capturer (latest)
          allowUpdates: true
          replacesArtifacts: true
          artifacts: "dist/*"
          body: |
            Capturer autobuild (multi-arch).
            Binaries: amd64/x86/armv6/armv7/arm64 (musl) and amd64/x86/armv7/arm64 (glibc).
            The `latest` tag always points to the most recent build.